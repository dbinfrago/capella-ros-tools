<!--
 ~ Copyright DB Netz AG and contributors
 ~ SPDX-License-Identifier: Apache-2.0
 -->

<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <link rel="icon" href="/static/icons/favicon.ico" />
        <title>{{ element.name }} - Overview</title>
        <link
            href="{{ url_for('static', path='/styles.css') }}"
            rel="stylesheet"
        />
        <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom-container@0.6.1"></script>
    </head>
    <body>
        <main>
            <h1>
                {{ element.name }}
                <span style="font-size: 70%">({{ element.xtype }})</span>
            </h1>
            <table>
                <tr>
                    <td>uuid</td>
                    <td>{{ element.uuid }}</td>
                </tr>
                <tr>
                    <td>parent</td>
                    <td>{{ element.parent._short_html_() }}</td>
                </tr>
                <tr>
                    <td>description</td>
                    <td>
                        <span>{{ element.description }}</span>
                    </td>
                </tr>
                <tr>
                    <td>properties</td>
                    <td>
                        <ol>
                            {% for prop in element.properties %}
                            <li>
                                <p>
                                    <strong>Property</strong> "{{ prop.name
                                    }}": {{prop.type.name}}
                                    <span>{{ prop.description }}</span>
                                </p>
                            </li>
                            {% endfor %}
                        </ol>
                    </td>
                </tr>
            </table>
        </main>
        <aside>
            <div>{{ element.tree_view.as_svg | safe }}</div>
            <script type="module">
                import * as d3 from "https://cdn.jsdelivr.net/npm/d3@7/+esm";
                // Select the SVG container
                const svg = d3.select(".ClassDiagramBlank");
                svg.attr("width", "100%").attr("height", "100%");

                // Create a new group element
                const svgContainer = svg.append("g");

                svgContainer.attr("id", "svgContainer");

                // Select all children of the SVG container except the new group
                const children = svg.selectAll(
                    ":scope > *:not(#svgContainer)"
                );

                // Move all children into the group
                children.each(function () {
                    svgContainer.node().appendChild(this);
                });

                svgContainer.select("rect").remove();

                function escapeUUIDForCSSSelector(uuid) {
                    // Escape first character if it's a digit
                    let escapedUUID = uuid[0].match(/^\d/)
                        ? "\\3" + uuid[0] + " " + uuid.slice(1)
                        : uuid;
                    // Escape hyphens
                    return escapedUUID.replace(/-/g, "\\-");
                }

                let groupedNodes = [];

                svgContainer.selectAll(".Box").each(function () {
                    var depElements = d3.select(this).selectAll("g");

                    if (groupedNodes.includes(this.id)) {
                        return;
                    }
                    groupedNodes.push(this.id);

                    var contextGroup = svgContainer.append("g");
                    contextGroup.attr("class", "contextGroup");

                    if (depElements.nodes().length == 0) {
                        contextGroup
                            .node()
                            .appendChild(d3.select(this).node());
                    } else {
                        depElements.nodes()[0].classList.forEach((id) => {
                            groupedNodes.push(id);
                            let escapedUUID = escapeUUIDForCSSSelector(id);
                            contextGroup
                                .node()
                                .appendChild(
                                    d3.select("#" + escapedUUID).node()
                                );
                        });
                    }
                });

                const draggableElements =
                    svgContainer.selectAll(".contextGroup");

                // Zoom and pan
                svg.call(
                    d3
                        .zoom()
                        .extent([
                            [0, 0],
                            [svg.node().clientWidth, svg.node().clientHeight],
                        ])
                        .scaleExtent([0.1, 10])
                        .on("zoom", (event) => {
                            svgContainer.attr("transform", event.transform);
                        })
                );

                // Create an array of data with the same length as your selection
                let data = Array.from(draggableElements.nodes(), () => ({
                    currentX: 0,
                    currentY: 0,
                    deltaX: 0,
                    deltaY: 0,
                }));

                // Bind the data to your elements
                draggableElements.data(data);

                // Apply the drag behavior to the selected elements
                draggableElements.call(
                    d3
                        .drag()
                        .on("start", dragStarted)
                        .on("drag", dragged)
                        .on("end", dragEnded)
                );

                function dragStarted(event, d) {
                    // Implement any custom behavior on drag start if needed
                    d.deltaX = event.x - d.currentX;
                    d.deltaY = event.y - d.currentY;
                }

                function dragged(event, d) {
                    // Implement any custom behavior on drag
                    d.currentX = event.x - d.deltaX;
                    d.currentY = event.y - d.deltaY;

                    d3.select(this).attr(
                        "transform",
                        `translate(${d.currentX},${d.currentY})`
                    );

                    var boundingBox = svgContainer.node().getBBox();
                    svgContainer
                        .attr("width", boundingBox.width)
                        .attr("height", boundingBox.height)
                        .attr(
                            "viewBox",
                            `${boundingBox.x} ${boundingBox.y} ${boundingBox.width} ${boundingBox.height}`
                        );
                }

                function dragEnded(event, d) {
                    d.deltaX = event.x;
                    d.deltaY = event.y;
                }
            </script>
        </aside>
    </body>
</html>
